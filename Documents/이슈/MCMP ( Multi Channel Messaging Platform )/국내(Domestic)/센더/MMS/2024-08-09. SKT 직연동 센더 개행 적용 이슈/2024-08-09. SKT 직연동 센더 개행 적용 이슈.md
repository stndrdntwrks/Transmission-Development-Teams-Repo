
#MMS #개행문자적용 #2024/08/12 #해결완료 


## 배경

> 직연동 MMS 배포 후에 고객사들이 전송한 MMS 메세지 중 SKT 이동통신사로 전송된 메세지들의 개행문자가 적용이 안되어 전송된다는 문의를 전달받음

- 개행문자 적용 안된 메세지 건의 예시
	![[스크린샷 2024-08-12 오후 5.15.09.png]]

	위와 같이 **`&#13;`** 는 고객사가 메세지 본문에 **`\n`** 를 담아 전송하여 전송 중 인코딩이 깨진 것으로 파악되며, 본문에 개행문자가 존재하였음에도 불구하고 메세지 본문에 줄바꿈이 적용되지 않은 채 전송되었다.

## 문제 파악 및 해결

1. 직연동 MMS 센더가 전송하는 이동통신사 중에서 KTF 와 LGT 는 메세지 본문에 작성된  **`\r\n`** 또는 **`\n`** 을 통해 줄바꿈이 적용되어 전송되나, SKT 의 경우 메세지 본문에 **`\r\n`** 또는 **`\n`** 이 존재하더라도 공백(" ") 으로 변환되어 전송되는 현상 확인함
 
2. SKT 의 경우, 독자적으로 SMIl 구조로 메세지 전송 요청해야하기 때문인 것으로 판단하고 XML 형태에서 사용하는 개행 문자 **`\r\n`**, **`\n`**, **`<br>`** , **`<br/>`** 모두 메세지 본문에 담아 전송 테스트 진행하였으나 아래와 같이 적용되어 전송되었음.

	1. **`\r\n`** : 공백(" ")으로 적용되어 메세지가 전송됨
		![[스크린샷 2024-08-12 오후 5.12.49.png]]
		
	2. **`\n`** : 공백(" ")으로 적용되어 메세지가 전송됨

	3. **`<br>`** : 메세지 본문에서 해당 태그가 문자로 인식되어 `</br>` 그대로 전송되었음
		![[스크린샷 2024-08-12 오후 5.14.00.png]]
	
	5. **`<br/>`** : 메세지 본문에서 해당 태그가 문자로 인식되어 `<br/>` 그대로 전송되었음
		![[스크린샷 2024-08-12 오후 5.13.20.png]]


2. 위의 개행문자 적용이 되리라 예상했던 여러 문자를 메세지 본문에 담아 전송하였으나 본문의 줄바꿈이 적용되지 않아 관련 SKT 담당자(**`010-3578-3362`**)를 찾아 연락하였고 담당자는 **`<div>`**  에 메세지 본문의 내용을 담아 전송하라는 이야기를 듣고 로직을 수정하여 메세지 전송 테스트를 진행함.

3. **`<div>`** 태그 안에 메세지 본문의 내용을 담아 전송하였으나 동일하게 본문의 내용이 줄바꿈되지 않은 채 전송되었으며 2번과 같이 여러 개행 문자를 사용하여 메세지 전송 테스트를 진행하였으나 정상 작동되지 않았음.

4. 하나의 메세지 본문의 줄바꿈이 있을 때마다 **`<div>`** 태그 안에 문자를 담아 SKT 전송 본문의 `<xt>` 태그의 **`<body>`** 안에 담도록 로직을 수정하고 전송 테스트를 진행했으나 줄바꿈은 된 것으로 확인되나 메세지 본문의 내용이 작성되지 않았음

	- 줄바꿈 적용된 문자
		![[스크린샷 2024-08-12 오후 5.12.09.png]]

5. **`<div>`** 를 SKT 메세지 전송 패킷 중 `<xt>` 태그의 **`<body>`** 안에 담아 전송하면 줄바꿈은 적용되나 **`<div>`** 안에 작성한 문자열은 같이 전송되지 않은 것을 확인하고 기존에 전송하던 것과 동일하게 **`<div>`** 안에 **`<color1>`** 본문 내용 중 일부를 작성한 태그를 만들어 메세지 전송 테스트를 진행하였다.

	- 본문 내용 중 줄바꿈이 정상 적용된 문자
		![[스크린샷 2024-08-12 오후 5.19.37.png]]

6. **`\n`** 만 작성한 경우, **`&#13;`** 과 같이 인코딩이 깨지는 경우를 방지하기 위해 `message.replaceAll("(?<!\r)\n", "\r\n");` 를 통해 모두 **`\r\n`** 으로 바꾼 후, 한 줄의 메세지를 작성하기 위해 `<div><color1></color1></div>` 를 생성하도록 코드를 수정하였다.
	
	- SKT 의 SMIL 중 `<xt>` 생성 로직 중 일부 발췌
	```java
	public static Document getSmilXhtmlDocument(String message) throws MCMPSoapRenderException {
		...
		message = message.replaceAll("(?<!\r)\n", "\r\n");  
		  
		String[] rows = message.split("\r\n");  
		for (int i = 0; i < rows.length; i++) {  
		    String row = rows[i];  
		    row = row.isEmpty() || row.isBlank() ? "" : row;  
		  
		    Element textOuterDiv = body.getOwnerDocument().createElement("div");  
		    Element color1 = textOuterDiv.getOwnerDocument().createElement("color1");  
		    color1.setTextContent(new String(row.getBytes(StandardCharsets.UTF_8))); // 띄워쓰기 문제  
		    textOuterDiv.appendChild(color1);  
		    body.appendChild(textOuterDiv);  
		}
		...
	}
	```